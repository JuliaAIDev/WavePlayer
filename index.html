<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <!--
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    /> 
    -->
    <!--- quil for text editor-->
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>

    <!--- wavesurfer  --->
    <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/plugins/minimap.min.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/plugins/zoom.min.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/wavesurfer.js@7/dist/plugins/timeline.min.js"></script>

    <!--- media control--->
    <script type="module" src="https://cdn.jsdelivr.net/npm/media-chrome@4/+esm"></script>

    <!--- icon--->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20,100,1,200&icon_names=favorite,home,search,settings"/>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=laps,repeat,repeat_on" />
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Wave Player</title>
  </head>

  <body>

  <h1>Wave Player</h1>

  <div id="info"> </div>
  <div id="file_panel" class="panel">
    <div id="open_url_form">
        <p>  <label for="audio_url">Enter the audio URL:</label> </p>
        <p>  
          <input type="url" id="audio_url" required />
          <button type=submit id="open_url_btn"> Load </button> 
        </p>
    </div>
    <p> or drag and drop your own audio file </p>
  </div>
  
  <div class="panel"> Title: <span id="audio_title" class="text-overflow-ellipses">audio.wav</span></div>

  <div id="main_view" class="panel"> <div id="drop"> 
    
    <div id="waveform_panel" class="waveform">
    <!-- the waveform will be rendered here -->
    </div>
    <media-controller audio>
        <audio id="audio"
          slot="media"
          src="https://stream.mux.com/O4h5z00885HEucNNa1rV02wZapcGp01FXXoJd35AHmGX7g/audio.m4a""
        ></audio>
        <media-control-bar keysused="nospace">
          <media-seek-backward-button seekoffset="15" keysused="nospace"></media-seek-backward-button>
          <media-play-button keysused="nospace"></media-play-button>
          <media-seek-forward-button seekoffset="15" keysused="nospace"></media-seek-forward-button>
          <media-time-display keysused="nospace"></media-time-display>
          <media-time-range keysused="nospace"></media-time-range>
          <media-duration-display keysused="nospace"></media-duration-display>
          <media-mute-button keysused="nospace"></media-mute-button>
          <media-volume-range keysused="nospace"></media-volume-range>
          <media-playback-rate-button rates="0.25 0.5 0.75 1.0 1.25 1.5 1.75 2" keysused="nospace"></media-playback-rate-button>
        
          <label class="toggle_checkbox">
            <input id="loop_region_checkbox" type="checkbox" checked/><span class="material-symbols-rounded switch_color">repeat</span>
          </label>
          <label class="toggle_checkbox">
            <input id="loop_whole_checkbox" type="checkbox" /> <span class="material-symbols-rounded switch_color">laps</span>
          </label>
        </media-control-bar>
    </media-controller>  
  </div></div>

  <div id="option_panel" class="panel">
    <!-- options for player -->
    <p>
      <label>
        <input type="checkbox" id='loop_checkbox' checked />
        loop 
      </label>
    </p>  
  </div>
  
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>


  <!-- Create the editor container -->
  <div id="editor">
   
  </div>
</body>





<script>
const quill = new Quill('#editor', {
  theme: 'snow',
  placeholder: 'paste transcripts here',
});

function onReady(){
  const mc = document.querySelector('media-controller');
  mc.hotkeys.add('noarrowleft', 'noarrowright', 'nospace', 'nof');

  let skipSeconds = 15
  let preservePitch = true
  let loop_region = true
  let loop_whole = false
  let loadingOverlayElem = document.getElementById("loadingOverlay") 

  // Toggle looping with a checkbox
  document.getElementById('loop_region_checkbox').onclick = (e) => {
    loop_region = e.target.checked
  }

  document.getElementById('loop_whole_checkbox').onclick = (e) => {
    loop_whole = e.target.checked
  }

  // region plugion
  const regions =  WaveSurfer.Regions.create({minLength:2})

  // minimap plugin
  const minimap = WaveSurfer.Minimap.create({
    height: 50,
    dragToSeek: true,
    overlayColor: 'rgba(200, 0, 200, 0.5)',
    waveColor: 'rgba(100, 100, 100, 0.7)',
    progressColor: 'rgba(50, 50, 50, 0.7)',
  })

  const zoom = WaveSurfer.Zoom.create({
    // the amount of zoom per wheel step, e.g. 0.5 means a 50% magnification per scroll
    scale: 0.5,
    maxZoom: 100
  })

  const ws = WaveSurfer.create({
    container: "#waveform_panel",
    minPxPerSec: 100,
    waveColor: 'rgb(200, 0, 200)',
    progressColor: 'rgb(100, 0, 100)',
    plugins: [regions, zoom, minimap, WaveSurfer.Timeline.create()],
    hideScrollbar: true,
    media: document.getElementById('audio'),
    autocenter: false,
    mediaControls: false,
    dragToSeek: false,
  })

  // setup regions
  let active_region = null
  regions.enableDragSelection({
    color: 'rgba(255, 0, 0, 0.1)',
  })

  // only one region
  regions.on('region-created', (region) => {
    regions.getRegions().forEach((r) => {
      if (r.id !== region.id) {
        r.remove();
      }
    });
    active_region = region
  });

  regions.on('region-in', (region) => {
    console.log("region-in")
    active_region = region
  })

  // loop region
  regions.on('region-out', (region) => {
    if (loop_region && active_region) { 
      active_region.play()
    } 
  })
  
  ws.on("decode", ()=>{
    // console.log("decode")
    ws.stop()
    regions.clearRegions()
    active_region = null
  })

  ws.on("finish", ()=>{
    // console.log("decode")
    if (loop_whole){
      ws.play()
    }
  })
  /*---- open url ----*/
  document.getElementById("open_url_btn").onclick = ()=>{
    url = document.getElementById("audio_url").value
    loadingOverlayElem.style.visibility = "visible"
    ws.load(url)
      .then(() => {
        document.getElementById("audio_title").textContent = url
      })
      .catch((e) => {
        alert("cannot open url: " + url)
      })
      .finally((e)=> {
        loadingOverlayElem.style.visibility = "hidden"
      })
 
  }
  
  // /*---- Shortcuts ----*/
  document.addEventListener('keyup', (event) => {
    
    // Do nothing if the event was already processed
    if (event.defaultPrevented) {
      return; 
    }
    
    // Do nothing if the event is not fired by document
    if (event.target.tagName != "BODY"){
      return;
    }
    switch (event.key) {
      case "d": // speed down
        new_speed = ws.getPlaybackRate() - 0.25
        new_speed = new_speed > 0.25 ? new_speed : 0.25
        ws.setPlaybackRate(new_speed)
        break;
      case "u": // speed up
        // Do something for "up arrow" key press.
        new_speed = ws.getPlaybackRate() + 0.25
        new_speed = new_speed < 2 ? new_speed : 2
        ws.setPlaybackRate(new_speed)
        break;
      case "n": // play at the normal speed
        ws.setPlaybackRate(1)
        break;  
      case "s": // play slowly
        ws.setPlaybackRate(0.5)
        break;
      case "f": // play fast
        ws.setPlaybackRate(2)
        break;
      case " ": // play or pause
        // Do something for "space" key press.
        ws.playPause()
        break; 
      case "ArrowLeft": // backward
        ws.skip(0-skipSeconds)
        break;
      case "ArrowRight": // forward
        // Do something for "right arrow" key press.
        ws.skip(skipSeconds)
        break;
      case "Enter":
        // Do something for "enter" or "return" key press.
        break;
      
      case "Delete":
        active_region = null
        regions.clearRegions()
        break;
      case "Escape":
        // Do something for "esc" key press.
        active_region = null
        break;

      default:
        return; // Quit when this doesn't handle the key event.
    }

    // Cancel the default action to avoid it being handled twice
    event.stopPropagation();

  });

  /*---- Drag'n'drop -----*/
  document.body.ondrop = (e) => {
    e.preventDefault()
  }
  // const dropArea = document.getElementById("#waveform_panel")
  const dropArea = document.querySelector('#drop')
  dropArea.ondragenter = (e) => {
    e.preventDefault()
    e.target.classList.add('over')
  }
  dropArea.ondragleave = (e) => {
    e.preventDefault()
    e.target.classList.remove('over')
  }
  dropArea.ondragover = (e) => {
    e.preventDefault()
  }
  dropArea.ondrop = (e) => {
    e.preventDefault()
    e.target.classList.remove('over')

    filename = e.dataTransfer.files[0].name
  
    // Read the audio file
    const reader = new FileReader()
    reader.onload = (event) => {
      loadingOverlayElem.style.visibility = "visible"
      ws.load(event.target.result).then(() => {
        document.getElementById("audio_title").textContent = filename
      })
      .catch((e) => {
        alert("cannot open file: " + filename)
      })
      .finally((e)=> {
        loadingOverlayElem.style.visibility = "hidden"
      })   
    }
    reader.readAsDataURL(e.dataTransfer.files[0])
  }
  
}
  
document.addEventListener("DOMContentLoaded", onReady)
</script>
</html>